<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>
<title>粉粉贪吃蛇·小悠特别版 (PWA v6.5)</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#ffd6e6">
<link rel="apple-touch-icon" href="icon-512.png">
<style>
  :root{
    --vh: 1vh;
    --controlsH: 22;           /* % of screen height, now can go to 100 via Settings */
    --controlsLift: 0;         /* px upward nudge for the whole controls area */
    --actionsPadRight: 80;     /* px inward padding for right-bottom buttons, range up to 200 */
    --tile: 22;
    --gap: 12px;
  }
  html, body { margin:0; height:calc(var(--vh) * 100); background:#ffd6e6; color:#5a4750; font-family:-apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial; }
  body::before{ content:''; position:fixed; inset:0; z-index:-2; background:linear-gradient(180deg,#ffd6e6 0%,#ffe9f1 100%); }
  body::after{ content:''; position:fixed; inset:0; z-index:-1; opacity:.18; background-image:url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHdpZHRoPScxMjAnIGhlaWdodD0nMTIwJyB2aWV3Qm94PScwIDAgMTIwIDEyMCc+CiAgPGcgZmlsbD0nbm9uZScgc3Ryb2tlPSdyZ2JhKDI1NSwxMjAsMTYwLDAuMjIpJyBzdHJva2Utd2lkdGg9JzMnPgogICAgPHBhdGggZD0nTTIwLDYwIFE0MCwyMCA2MCw0MCBRODAsMjAgMTAwLDYwIFE4MCwxMDAgNjAsODAgUTQwLDEwMCAyMCw2MCBaJy8+CiAgICA8Y2lyY2xlIGN4PSc2MCcgY3k9JzYwJyByPSc2JyBmaWxsPSdyZ2JhKDI1NSwxMjAsMTYwLDAuMjIpJy8+CiAgPC9nPgo8L3N2Zz4="); background-size:160px 160px; background-repeat:repeat; pointer-events:none; }

  #wrap{ display:flex; flex-direction:column; min-height:calc(var(--vh)*100); padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); }
  #gameArea{ height: calc(var(--vh) * (100 - var(--controlsH)) - env(safe-area-inset-top)); display:flex; align-items:center; justify-content:center; padding:4px 8px 2px; min-height:80px; }
  #stage{ position:relative; width:min(96vw, 900px); height:100%; display:flex; align-items:center; justify-content:center; }
  canvas{ background:#fff5faCC; backdrop-filter: blur(2px); border-radius:16px; box-shadow:0 8px 28px rgba(255,105,180,.25); }
  #hud{ position:absolute; top:6px; left:8px; display:flex; gap:10px; font-size:14px; color:#614d55; }
  #msg{ position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:#ffffffcc; color:#c0396e; padding:10px 14px; border-radius:12px; display:none; box-shadow:0 6px 18px rgba(0,0,0,.08); }
  #win{ position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:#fff0f7; color:#c0396e; padding:12px 16px; border-radius:14px; display:none; box-shadow:0 8px 28px rgba(255,105,180,.25); }

  #controls{ height: calc(var(--vh) * var(--controlsH)); position:relative; }
  #controlsInner{ position:absolute; left:0; right:0; top:0; bottom:0; display:grid; grid-template-columns: 1fr 1fr;
                  padding-bottom: calc(env(safe-area-inset-bottom) + 2px);
                  transform: translateY(calc(var(--controlsLift) * -1px)); }
  #dpadWrap{ display:flex; align-items:center; justify-content:center; }
  #dpad{ display:grid; gap: var(--gap); grid-template-areas: ". up ." "left . right" ". down ."; }
  .btn{ width:86px; height:86px; border-radius:20px; border:1px solid #ffc1d6; background:#ffe3ee; color:#b14a76; font-size:22px; box-shadow:0 4px 12px rgba(255,105,180,.18); }
  .btn:active{ transform:scale(.97); }
  @media (max-width:380px){ .btn{ width:68px; height:68px; } }
  #actionsWrap{ display:flex; align-items:flex-end; justify-content:flex-end; padding:8px; padding-right: calc(env(safe-area-inset-right) + var(--actionsPadRight)*1px); gap:10px; }
  #pause,#restart{ width:64px; height:64px; border-radius:18px; border:none; background:linear-gradient(180deg,#ffcfe1,#ffb7d1); color:#fff; box-shadow:0 6px 16px rgba(255,105,180,.28); display:flex; align-items:center; justify-content:center; }
  #pause svg, #restart svg{ width:28px; height:28px; opacity:.95; }

  #settings{ position:absolute; top:6px; right:6px; display:flex; gap:8px; }
  .chip{ padding:6px 10px; border-radius:14px; background:#ffcee0; border:1px solid #ffb7cf; color:#a33e6a; font-size:12px; }
  #panel{ position:absolute; top:40px; right:6px; background:#fff7fb; border:1px solid #ffd1e2; border-radius:12px; padding:10px; box-shadow:0 8px 24px rgba(0,0,0,.08); display:none; min-width:260px; }
  #panel label{ font-size:12px; display:block; margin:6px 0 2px; }
  #panel input[type=range]{ width:240px; max-width:60vw; }
  #panel input[type=url]{ width:240px; max-width:60vw; padding:6px 8px; border-radius:8px; border:1px solid #ffc9dc; }

  #toast{ position:fixed; left:50%; bottom: calc(env(safe-area-inset-bottom) + 64px); transform:translateX(-50%); background:#000000a0; color:#fff; padding:8px 12px; border-radius:10px; font-size:12px; display:none; z-index:9999; }
</style>
</head>
<body>
<div id="wrap">
  <div id="gameArea">
    <div id="stage">
      <canvas id="cv" width="726" height="528" aria-label="游戏画面"></canvas>
      <div id="hud"><span id="score">分数: 0</span><span id="speed">速度: 7</span></div>
      <div id="msg" role="alert"></div>
      <div id="win">💖 恭喜通关！小悠把你抱下线啦～</div>

      <div id="settings">
        <button class="chip" id="menu">⚙️ 设置</button>
        <button class="chip" id="sfx">音效: 开</button>
        <button class="chip" id="bgm">音乐: 开</button>
      </div>
      <div id="panel">
        <label>按键区高度（% 屏幕，0–100）：<span id="ctlVal">22</span>%</label>
        <input id="ctlRange" type="range" min="0" max="100" step="1" value="22"/>
        <label>按键区上移偏移（px，0–120）：<span id="liftVal">0</span></label>
        <input id="liftRange" type="range" min="0" max="120" step="2" value="0"/>
        <label>右下角按钮向内偏移（px，0–200）：<span id="padVal">80</span></label>
        <input id="padRange" type="range" min="0" max="200" step="2" value="80"/>
        <label>蛇速起始值：</label>
        <input id="spdRange" type="range" min="5" max="10" step="0.5" value="7"/>
        <label style="margin-top:8px;">自定义 BGM（MP3 直链，可选）：</label>
        <input id="musicURL" type="url" placeholder="https://.../happy.mp3"/>
        <div style="margin-top:8px; display:flex; gap:6px; flex-wrap:wrap;">
          <button class="chip" id="apply">应用并保存</button>
          <button class="chip" id="close">关闭</button>
          <button class="chip" id="reset">重置默认</button>
        </div>
      </div>
    </div>
  </div>

  <div id="controls" aria-label="控制区">
    <div id="controlsInner">
      <div id="dpadWrap">
        <div id="dpad">
          <button class="btn" id="up"    style="grid-area:up;">↑</button>
          <button class="btn" id="left"  style="grid-area:left;">←</button>
          <button class="btn" id="right" style="grid-area:right;">→</button>
          <button class="btn" id="down"  style="grid-area:down;">↓</button>
        </div>
      </div>
      <div id="actionsWrap">
        <button id="pause" title="暂停">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><rect x="6" y="5" width="4" height="14" fill="white"/><rect x="14" y="5" width="4" height="14" fill="white"/></svg>
        </button>
        <button id="restart" title="重新开始">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 5v-3l5 4-5 4V7a5 5 0 1 0 5 5h2A7 7 0 1 1 12 5z" fill="white"/></svg>
        </button>
      </div>
    </div>
  </div>
</div>

<div id="toast">首次点一下屏幕以开启音乐 🎵</div>

<script>
// SW
if ('serviceWorker' in navigator) { window.addEventListener('load', ()=>navigator.serviceWorker.register('service-worker.js')); }
// visualViewport -> --vh
(function(){
  function setVH(){
    const vv = window.visualViewport;
    const h = (vv ? vv.height : window.innerHeight);
    document.documentElement.style.setProperty('--vh', (h/100) + 'px');
  }
  setVH();
  window.addEventListener('resize', setVH);
  if(window.visualViewport){ window.visualViewport.addEventListener('resize', setVH); }
})();
</script>
<script>
(function(){ 'use strict';
  const TILE=22, W=30, H=22;
  const cv=document.getElementById('cv'), ctx=cv.getContext('2d');
  const scoreEl=document.getElementById('score'), speedEl=document.getElementById('speed');
  const msg=document.getElementById('msg'), winEl=document.getElementById('win');
  const toast=document.getElementById('toast');

  // Persisted settings
  const saved = JSON.parse(localStorage.getItem('xy_snake_settings')||'{}');
  function setVar(name, val){ document.documentElement.style.setProperty(name, val); }

  if(saved.controlsH){ setVar('--controlsH', saved.controlsH); }
  if(saved.controlsLift){ setVar('--controlsLift', saved.controlsLift); }
  if(saved.actionsPadRight){ setVar('--actionsPadRight', saved.actionsPadRight); }
  let startSpeed = saved.startSpeed ? parseFloat(saved.startSpeed) : 7;
  let customURL = saved.musicURL || '';
  let sfxOn = saved.sfxOn===false ? false : true;
  let bgmOn = saved.bgmOn===false ? false : true;

  // DPR crisp canvas
  function setupCanvas(){
    const dpr = window.devicePixelRatio || 1;
    const cssW = cv.clientWidth;
    const cssH = cv.clientHeight;
    cv.width = Math.floor(cssW * dpr);
    cv.height= Math.floor(cssH * dpr);
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  }

  function fit(){
    const stage=document.getElementById('stage');
    const gw=stage.clientWidth, gh=stage.clientHeight;
    const scale=Math.min(gw/(W*TILE), gh/(H*TILE));
    cv.style.width=(W*TILE*scale)+'px';
    cv.style.height=(H*TILE*scale)+'px';
    setupCanvas();
  }
  new ResizeObserver(fit).observe(document.getElementById('stage')); fit();

  const COL={ grid:'#ffffff33', apple:'#ff6b88', mail:'#ff5fa3', body:'#ff9fbc', head:'#ff6fa5', eye:'#4c2d3a' };

  // --- Audio ---
  const DEFAULT_BGM = "https://files.freemusicarchive.org/storage-freemusicarchive-org/music/no_curator/Komiku/Its_time_for_adventure/Komiku_-_12_-_Friendship.mp3";
  const AC=window.AudioContext||window.webkitAudioContext; let ac, master, bgmTimer=null, userAudio=null;
  function ensureAudio(){ if(!ac){ ac=new AC(); master=ac.createGain(); master.gain.value=0.6; master.connect(ac.destination);} }
  function beep(f=660,d=0.06,t='triangle',g=0.18){ if(!sfxOn||!ac) return; const o=ac.createOscillator(), gNode=ac.createGain(); o.type=t; o.frequency.value=f; gNode.gain.value=g; o.connect(gNode); gNode.connect(master); const t0=ac.currentTime; o.start(t0); gNode.gain.exponentialRampToValueAtTime(0.001,t0+d); o.stop(t0+d); }
  function startDefaultBGMWebAudio(){
    if(!bgmOn||!ac||bgmTimer || userAudio) return;
    let t=ac.currentTime+0.05;
    function bar(){
      const chords=[[261.63,392.00],[196.00,392.00],[220.00,440.00],[174.61,349.23]];
      for(let k=0;k<chords.length;k++){
        const [f1,f2]=chords[k];
        const o1=ac.createOscillator(), o2=ac.createOscillator();
        const g=ac.createGain(); g.gain.value=0.05; o1.type='triangle'; o2.type='sine';
        o1.frequency.value=f1; o2.frequency.value=f2;
        o1.connect(g); o2.connect(g); g.connect(master);
        o1.start(t+k*0.6); o2.start(t+k*0.6);
        g.gain.setValueAtTime(0.05, t+k*0.6);
        g.gain.exponentialRampToValueAtTime(0.0001, t+k*0.6+0.55);
        o1.stop(t+k*0.6+0.6); o2.stop(t+k*0.6+0.6);
      }
      t+=2.4;
      if(bgmOn && !userAudio){ bgmTimer=setTimeout(bar, 2200); }
    }
    bar();
  }
  function startURLBGM(url){
    try{
      userAudio = new Audio(url);
      userAudio.loop = true;
      userAudio.volume = 0.42;
      userAudio.play().catch(()=>{});
    }catch(e){ console.log('music error',e); }
  }
  function stopBGM(){ if(bgmTimer){ clearTimeout(bgmTimer); bgmTimer=null; } if(userAudio){ try{userAudio.pause();}catch(e){} } }

  // --- Game ---
  let snake=[], dir=[1,0], queue=[], len=4;
  let speed=startSpeed, score=0, paused=false, over=false, win=false;
  let apple=null, mail=null, mailTTL=0;

  function rndEmpty(occ){
    while(true){
      const c=[Math.floor(Math.random()*W), Math.floor(Math.random()*H)];
      if(!occ.has(JSON.stringify(c))) return c;
    }
  }
  function ensureApple(){
    if(!apple){
      const occ=new Set(snake.map(JSON.stringify));
      apple = rndEmpty(occ);
    }
  }

  function initState(){
    const cx=Math.floor(W/2), cy=Math.floor(H/2);
    snake=[[cx,cy]]; dir=[1,0]; queue=[]; len=4; score=0; paused=false; over=false; win=false;
    apple=null; mail=null; mailTTL=0;
    ensureApple();
    speedEl.textContent='速度: '+speed.toFixed(1);
  }

  function setDir(nx,ny){ if(nx===-dir[0] && ny===-dir[1]) return; queue.push([nx,ny]); if(sfxOn) beep(240,0.05,'square',0.06); }

  const V=(ms)=>{ try{ if('vibrate' in navigator) navigator.vibrate(ms);}catch(e){} }
  function showToast(){ const t=toast; t.style.display='block'; setTimeout(()=>t.style.display='none', 1800); }
  window.addEventListener('load', ()=>{ if(bgmOn) showToast(); });
  ['touchstart','mousedown'].forEach(ev=>window.addEventListener(ev,()=>{
    ensureAudio();
    if(bgmOn){
      const url = (customURL && customURL.length>6) ? customURL : DEFAULT_BGM;
      if(url && url.startsWith('http')){ startURLBGM(url); } else { startDefaultBGMWebAudio(); }
    }
  },{once:true}));

  document.getElementById('pause').onclick=()=>{ ensureAudio(); paused=!paused; V(8); };
  document.getElementById('restart').onclick=()=>{ ensureAudio(); initState(); V(15); };

  document.getElementById('up').onclick=()=>{ ensureAudio(); setDir(0,-1); V(10); };
  document.getElementById('down').onclick=()=>{ ensureAudio(); setDir(0, 1); V(10); };
  document.getElementById('left').onclick=()=>{ ensureAudio(); setDir(-1,0); V(10); };
  document.getElementById('right').onclick=()=>{ ensureAudio(); setDir(1, 0); V(10); };

  // Settings panel
  const menu=document.getElementById('menu'), panel=document.getElementById('panel');
  const ctlRange=document.getElementById('ctlRange'), ctlVal=document.getElementById('ctlVal');
  const liftRange=document.getElementById('liftRange'), liftVal=document.getElementById('liftVal');
  const padRange=document.getElementById('padRange'), padVal=document.getElementById('padVal');
  const musicURL=document.getElementById('musicURL');
  const sfxBtn=document.getElementById('sfx'), bgmBtn=document.getElementById('bgm');
  const spdRange=document.getElementById('spdRange');

  ctlRange.value = saved.controlsH || 22; ctlVal.textContent = ctlRange.value;
  liftRange.value = saved.controlsLift || 0; liftVal.textContent = liftRange.value;
  padRange.value = saved.actionsPadRight || 80; padVal.textContent = padRange.value;
  spdRange.value = startSpeed;
  if(customURL) musicURL.value = customURL;
  sfxBtn.textContent = '音效: ' + (sfxOn ? '开':'关');
  bgmBtn.textContent = '音乐: ' + (bgmOn ? '开':'关');

  function applySettings(persist){
    setVar('--controlsH', ctlRange.value);
    setVar('--controlsLift', liftRange.value);
    setVar('--actionsPadRight', padRange.value);
    speed = parseFloat(spdRange.value);
    speedEl.textContent='速度: '+speed.toFixed(1);
    customURL = musicURL.value.trim();
    if(persist){
      const data = {
        controlsH: ctlRange.value,
        controlsLift: liftRange.value,
        actionsPadRight: padRange.value,
        startSpeed: speed,
        musicURL: customURL,
        sfxOn: sfxOn, bgmOn: bgmOn
      };
      localStorage.setItem('xy_snake_settings', JSON.stringify(data));
    }
    fit();
  }

  sfxBtn.onclick=()=>{ sfxOn=!sfxOn; sfxBtn.textContent='音效: '+(sfxOn?'开':'关'); const d=JSON.parse(localStorage.getItem('xy_snake_settings')||'{}'); d.sfxOn=sfxOn; localStorage.setItem('xy_snake_settings', JSON.stringify(d)); };
  bgmBtn.onclick=()=>{ bgmOn=!bgmOn; bgmBtn.textContent='音乐: '+(bgmOn?'开':'关'); const d=JSON.parse(localStorage.getItem('xy_snake_settings')||'{}'); d.bgmOn=bgmOn; localStorage.setItem('xy_snake_settings', JSON.stringify(d)); if(!bgmOn){ stopBGM(); } };
  menu.onclick=()=>{ panel.style.display = (panel.style.display==='block') ? 'none' : 'block'; };
  ctlRange.oninput=()=>{ ctlVal.textContent=ctlRange.value; };
  liftRange.oninput=()=>{ liftVal.textContent=liftRange.value; };
  padRange.oninput=()=>{ padVal.textContent=padRange.value; };
  document.getElementById('apply').onclick=()=>{ applySettings(true); panel.style.display='none'; };
  document.getElementById('close').onclick=()=>{ panel.style.display='none'; };
  document.getElementById('reset').onclick=()=>{
    localStorage.removeItem('xy_snake_settings');
    ctlRange.value=22; ctlVal.textContent='22';
    liftRange.value=0; liftVal.textContent='0';
    padRange.value=80; padVal.textContent='80';
    spdRange.value=7; musicURL.value=''; customURL='';
    sfxOn=true; bgmOn=true; sfxBtn.textContent='音效: 开'; bgmBtn.textContent='音乐: 开';
    applySettings(true);
  };

  function reset(){
    initState();
    msg.style.display='none'; winEl.style.display='none';
  }

  function tick(){
    if(!paused && !over && !win){
      while(queue.length){ const [nx,ny]=queue.shift(); if(!(nx===-dir[0] && ny===-dir[1])){ dir=[nx,ny]; break; } }
      const [hx,hy]=snake[0]; const nx=hx+dir[0], ny=hy+dir[1];
      if(nx<0||ny<0||nx>=W||ny>=H){ over=true; V(120); ensureAudio(); beep(120,0.25,'sawtooth',0.3); }
      else{
        const head=[nx,ny];
        for(let i=0;i<snake.length;i++){ if(snake[i][0]===head[0]&&snake[i][1]===head[1]){ over=true; V(120); ensureAudio(); beep(120,0.25,'sawtooth',0.3); break; } }
        if(!over){
          snake.unshift(head);
          if(snake.length>len) snake.pop();
          // apple win/collect
          ensureApple();
          if(head[0]===apple[0] && head[1]===apple[1]){
            len++; score+=10; speed=Math.min(14, speed+0.25); V(30); ensureAudio();
            beep(523.25,0.06,'triangle',0.16); setTimeout(()=>beep(659.25,0.06,'triangle',0.16),70); setTimeout(()=>beep(783.99,0.07,'triangle',0.16),140);
            const occ=new Set(snake.map(JSON.stringify));
            apple=rndEmpty(occ);
            if(!mail && Math.random()<0.06){ mail=rndEmpty(occ); mailTTL=500; }
            speedEl.textContent='速度: '+speed.toFixed(1);
          }
          // mail win
          if(mail && head[0]===mail[0] && head[1]===mail[1]){ win=true; V(60); ensureAudio(); beep(880,0.15,'triangle',0.25); setTimeout(()=>beep(1175,0.15,'triangle',0.25),120); }
        }
      }
    }
    if(mail){ if(--mailTTL<=0){ mail=null; } }
    draw();
    setTimeout(tick, 1000/Math.max(5, speed));
  }

  function rr(x,y,w,h,r){ r=Math.min(r,w/2,h/2); ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); }
  function cell(x,y,color,rad=8){ const px=x*TILE, py=y*TILE; ctx.fillStyle=color; rr(px+1,py+1,TILE-2,TILE-2,rad); ctx.fill(); }
  function head(x,y){
    const px=x*TILE, py=y*TILE;
    ctx.fillStyle=COL.head; rr(px+1,py+1,TILE-2,TILE-2,10); ctx.fill();
    ctx.fillStyle=COL.eye; ctx.beginPath(); ctx.arc(px+TILE*0.35, py+TILE*0.40, 2.2, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(px+TILE*0.65, py+TILE*0.40, 2.2, 0, Math.PI*2); ctx.fill();
  }
  function drawApple(x,y){ cell(x,y,COL.apple,8); }
  function drawMail(x,y){
    const px=x*TILE, py=y*TILE;
    ctx.fillStyle = COL.mail; rr(px+3,py+5,TILE-6,TILE-10,6); ctx.fill();
    ctx.fillStyle = '#ffffffcc'; ctx.beginPath(); ctx.moveTo(px+4, py+6); ctx.lineTo(px+TILE-4, py+6); ctx.lineTo(px+TILE/2, py+TILE/2); ctx.closePath(); ctx.fill();
    ctx.fillStyle = '#ffecf4'; ctx.fillRect(px+4, py+TILE/2-1, TILE-8, 2);
  }

  function draw(){
    ctx.clearRect(0,0,cv.width,cv.height);
    ctx.strokeStyle='#ffffff35'; ctx.lineWidth=0.6;
    for(let x=0;x<=W;x++){ ctx.beginPath(); ctx.moveTo(x*TILE+0.5,0); ctx.lineTo(x*TILE+0.5,H*TILE); ctx.stroke(); }
    for(let y=0;y<=H;y++){ ctx.beginPath(); ctx.moveTo(0,y*TILE+0.5); ctx.lineTo(W*TILE,y*TILE+0.5); ctx.stroke(); }

    ensureApple();
    if(apple) drawApple(apple[0], apple[1]);
    if(mail) drawMail(mail[0], mail[1]);

    for(let i=0;i<snake.length;i++){ const [x,y]=snake[i]; if(i===0) head(x,y); else cell(x,y,COL.body,10); }

    scoreEl.textContent='分数: '+score;
    if(over){ msg.textContent='Game Over ～ 撞墙/咬到尾巴了'; msg.style.display='block'; } else if(win){ winEl.style.display='block'; } else { msg.style.display='none'; winEl.style.display='none'; }
  }

  initState();
  tick();
})();</script>
</body>
</html>
