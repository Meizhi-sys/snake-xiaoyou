<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>
<title>粉粉贪吃蛇 (v6.7)</title>

<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon-180.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="theme-color" content="#ffd6e6">

<style>
  :root{ --vh:1vh; --controlsH:45; --controlsLift:44; --actionsPadRight:30; --gap:12px; --gutterX:8px; }
  html,body{ margin:0; height:calc(var(--vh)*100); overflow:hidden; background:#ffd6e6; color:#5a4750; font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial; overscroll-behavior:none; touch-action:none;}
  body::before{content:'';position:fixed;inset:0;z-index:-2;background:linear-gradient(180deg,#ffd6e6 0%,#ffe9f1 100%);}
  #wrap{ position:fixed; inset:0; display:flex; flex-direction:column; min-height:calc(var(--vh)*100);
         padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); }
  #gameArea{ height: calc(var(--vh)*(100 - var(--controlsH)) - env(safe-area-inset-top)); display:flex; align-items:center; justify-content:center; padding:2px var(--gutterX); min-height:80px; width:100vw;}
  #stage{ position:relative; width: calc(100vw - env(safe-area-inset-left) - env(safe-area-inset-right) - var(--gutterX)*2);
          max-width: calc(100vw - env(safe-area-inset-left) - env(safe-area-inset-right) - var(--gutterX)*2); height:100%; overflow:hidden;
          display:flex; align-items:center; justify-content:center;}
  canvas{ max-width:100%; display:block; background:#fff5faCC; backdrop-filter: blur(2px); border-radius:16px;
          box-shadow:0 8px 28px rgba(255,105,180,.25); touch-action:none;}
  #hud{ position:absolute; top:6px; left:8px; display:flex; gap:10px; font-size:14px; color:#614d55; z-index:5; background:#ffffffb8; padding:2px 6px; border-radius:8px; }
  #msg{ position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:#ffffffcc; color:#c0396e; padding:10px 14px; border-radius:12px; display:none; box-shadow:0 6px 18px rgba(0,0,0,.08); }
  #banner{ position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:#ffecf6; color:#c0396e; padding:12px 18px; border-radius:14px; display:none; box-shadow:0 10px 30px rgba(255,105,180,.28); font-weight:600; }
  #confetti{ position:absolute; inset:0; pointer-events:none; display:none; }
  #win{ position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:#fff0f7; color:#c0396e; padding:12px 16px; border-radius:14px; display:none; box-shadow:0 8px 28px rgba(255,105,180,.25); }

  #controls{ height: calc(var(--vh) * var(--controlsH)); position:relative;}
  #controlsInner{ position:absolute; inset:0; display:grid; grid-template-columns:1fr 1fr;
                  padding-bottom:calc(env(safe-area-inset-bottom)+2px); transform:translateY(calc(var(--controlsLift)*-1px));}
  #dpadWrap{ display:flex; align-items:center; justify-content:center;}
  #dpad{ display:grid; gap: var(--gap); grid-template-areas: ". up ." "left . right" ". down ."; }
  .btn{ width:86px; height:86px; border-radius:20px; border:1px solid #ffc1d6; background:#ffe3ee; color:#b14a76; font-size:22px; box-shadow:0 4px 12px rgba(255,105,180,.18); }
  .btn:active{ transform:scale(.97); }
  @media (max-width:380px){ .btn{ width:68px; height:68px; } }

  #actionsWrap{ position:absolute; right: calc(env(safe-area-inset-right) + var(--actionsPadRight)*1px); bottom: 8px; display:flex; align-items:flex-end; justify-content:flex-end; gap:10px; pointer-events:auto; }
  #pause,#restart{ width:64px; height:64px; border-radius:18px; border:none; background:linear-gradient(180deg,#ffcfe1,#ffb7d1); color:#fff; box-shadow:0 6px 16px rgba(255,105,180,.28); display:flex; align-items:center; justify-content:center; }
  #pause svg, #restart svg{ width:28px; height:28px; opacity:.95; }

  #settings{ position:absolute; top:6px; right:8px; display:flex; gap:8px; transform: translateX(12px); }
  .chip{ padding:6px 10px; border-radius:14px; background:#ffcee0; border:1px solid #ffb7cf; color:#a33e6a; font-size:12px; }

  /* 设置面板：独立滚动容器 + 固定底部按钮（确认永远可点） */
  #panelMask{ position:fixed; inset:0; display:none; z-index:9998; }
  #panelMask.show{ display:block; }
  #panelMask::before{ content:''; position:absolute; inset:0; background:rgba(0,0,0,.12); backdrop-filter: blur(2px); }
  #panel{
    position:fixed; top:48px; right:8px; left:auto;
    background:#fff7fb; border:1px solid #ffd1e2; border-radius:12px;
    box-shadow:0 14px 38px rgba(0,0,0,.12); min-width:320px; max-width:min(92vw,540px);
    max-height: calc(var(--vh)*75); display:flex; flex-direction:column;
    transform: scale(.86); opacity:0; transition: transform .18s ease, opacity .18s ease;
  }
  #panelMask.show #panel{ transform: scale(1); opacity:1; }
  #panelContent{
    overflow:auto; -webkit-overflow-scrolling:touch; overscroll-behavior:contain;
    padding:10px; padding-bottom:16px; max-height: calc(var(--vh)*75 - 64px);
  }
  #panelContent label{ font-size:12px; display:block; margin:6px 0 2px; }
  #panelContent input[type=range], #panelContent select{ width:260px; max-width:70vw; }
  #panelContent .row{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
  #panelFooter{ position:sticky; bottom:0; background:#fff7fb; border-top:1px solid #ffd1e2;
    padding:8px 10px; display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end; z-index:1; }
  #skins{ display:flex; gap:8px; flex-wrap:wrap; }
  .skin{ padding:6px 10px; border-radius:10px; border:1px solid #ffd1e2; background:#fff; cursor:pointer; }
  .skin.locked{ opacity:.5; filter:grayscale(1); }

  /* 开始遮罩：fixed + 顶层 + 任意点可开始 */
  #startMask{ position: fixed; inset:0; display:flex; align-items:center; justify-content:center;
    background:rgba(255,230,240,.85); z-index: 9999; pointer-events:auto;}
  #startMask *{ pointer-events:auto; }
  #startCard{background:#fff7fb; border:1px solid #ffd1e2; border-radius:14px; padding:18px 20px; box-shadow:0 14px 38px rgba(0,0,0,.12); text-align:center;}
  #startCard h1{margin:0 0 10px; font-size:18px; color:#a23e6b;}
  #startBtn{padding:10px 18px; border:none; border-radius:12px; background:#ffb7d1; color:#fff; font-weight:600; box-shadow:0 6px 16px rgba(255,105,180,.28);}

  /* 终章弹窗 */
  #finaleMask{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.25); z-index:9999;}
  #finale{ background:#fff7fb; border:1px solid #ffd1e2; border-radius:16px; padding:18px 22px; text-align:center; box-shadow:0 16px 48px rgba(0,0,0,.18);}
  #finale h2{ margin:0 0 8px; color:#a23e6b; }
  #finale p{ margin:6px 0 14px; }
  #finale .cta{ padding:10px 16px; border:none; border-radius:12px; background:#ffb7d1; color:#fff; font-weight:600; }
</style>
</head>
<body>
<div id="wrap">
  <div id="gameArea">
    <div id="stage">
      <canvas id="cv" width="660" height="484" aria-label="游戏画面"></canvas>
      <canvas id="confetti"></canvas>
      <div id="hud"><span id="score">分数: 0</span><span id="level">关卡: 1</span><span id="speed">速度: 7</span></div>
      <div id="msg" role="alert"></div>
      <div id="banner">➡️ 下一关！</div>
      <div id="win">💖 恭喜通关！</div>

      <!-- 开始遮罩 -->
      <div id="startMask">
        <div id="startCard">
          <h1>粉粉贪吃蛇 · 小悠特别版</h1>
          <button id="startBtn">▶ 开始游戏</button>
        </div>
      </div>

      <div id="settings">
        <button class="chip" id="menu">⚙️ 设置</button>
        <button class="chip" id="sfx">音效: 开</button>
        <button class="chip" id="bgmToggle">音乐: 开</button>
      </div>

      <!-- 设置面板 -->
      <div id="panelMask" aria-hidden="true">
        <div id="panel" role="dialog" aria-modal="true">
          <div id="panelContent">
            <label>按键区高度（% 屏幕，0–100）：<span id="ctlVal">45</span>%</label>
            <input id="ctlRange" type="range" min="0" max="100" step="1" value="45"/>

            <div class="row">
              <label style="min-width:110px;">棋盘颗粒：</label>
              <select id="boardPreset">
                <option value="30x22">标准 (30×22)</option>
                <option value="26x18" selected>大号 (26×18)</option>
                <option value="22x16">超大 (22×16)</option>
              </select>
            </div>

            <div class="row">
              <label style="min-width:110px;">撞墙规则：</label>
              <select id="wallMode">
                <option value="wrap" selected>穿越（不死亡）</option>
                <option value="die">死亡</option>
              </select>
            </div>

            <div class="row">
              <label style="min-width:110px;">食物样式：</label>
              <select id="foodStyle">
                <option value="pixel" selected>像素点</option>
                <option value="candy">糖果</option>
              </select>
            </div>

            <div class="row">
              <label style="min-width:110px;">吃到是否加速：</label>
              <select id="speedUp">
                <option value="off" selected>关（保持初始）</option>
                <option value="on">开（每个+0.25）</option>
              </select>
            </div>

            <label>蛇速起始值：</label>
            <input id="spdRange" type="range" min="5" max="10" step="0.5" value="7"/>

            <hr style="border:none;border-top:1px solid #ffd4e4;margin:8px 8px;">

            <div class="row">
              <label style="min-width:110px;">关卡模式：</label>
              <select id="levelMode">
                <option value="on" selected>开（每 +100 分升一关）</option>
                <option value="off">关（无尽）</option>
              </select>
            </div>
            <label>每关目标分（20–200）：<span id="tsVal">100</span></label>
            <input id="tsRange" type="range" min="20" max="200" step="10" value="100"/>

            <hr style="border:none;border-top:1px solid #ffd4e4;margin:8px 8px;">

            <label>当前皮肤（可点击切换，🔒为未解锁）：</label>
            <div id="skins"></div>
          </div>

          <div id="panelFooter">
            <button class="chip" id="apply">应用并保存</button>
            <button class="chip" id="close">关闭</button>
            <button class="chip" id="reset">重置默认</button>
          </div>
        </div>
      </div>
      <!-- /设置面板 -->

      <!-- 终章 -->
      <div id="finaleMask">
        <div id="finale">
          <h2 id="finaleTitle">🎀 恭喜你下班了！✨</h2>
          <p>粉金王冠纪念皮肤已解锁并自动装备～</p>
          <button class="cta" id="finaleRestart">重新开始</button>
        </div>
      </div>

    </div>
  </div>

  <div id="controls" aria-label="控制区">
    <div id="controlsInner">
      <div id="dpadWrap">
        <div id="dpad">
          <button class="btn" id="up"    style="grid-area:up;">↑</button>
          <button class="btn" id="left"  style="grid-area:left;">←</button>
          <button class="btn" id="right" style="grid-area:right;">→</button>
          <button class="btn" id="down"  style="grid-area:down;">↓</button>
        </div>
      </div>
      <div id="actionsWrap">
        <button id="pause" title="暂停">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><rect x="6" y="5" width="4" height="14" fill="white"/><rect x="14" y="5" width="4" height="14" fill="white"/></svg>
        </button>
        <button id="restart" title="重新开始">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 5v-3l5 4-5 4V7a5 5 0 1 0 5 5h2A7 7 0 1 1 12 5z" fill="white"/></svg>
        </button>
      </div>
    </div>
  </div>
</div>

<audio id="bgm" src="friendship.mp3" preload="auto" loop playsinline></audio>

<script>
  // SW 注册 + iOS 视口修正
  if ('serviceWorker' in navigator) { navigator.serviceWorker.register('service-worker.js').catch(()=>{}); }
  (function(){ function setVH(){const vv=window.visualViewport;const h=(vv?vv.height:window.innerHeight);document.documentElement.style.setProperty('--vh',(h/100)+'px');}
    setVH(); addEventListener('resize',setVH); if(window.visualViewport){visualViewport.addEventListener('resize',setVH);} })();
</script>

<script>
(function(){ 'use strict';
  /* ---------- DOM ---------- */
  const cv=document.getElementById('cv'), ctx=cv.getContext('2d');
  const conf=document.getElementById('confetti'), cctx=conf.getContext('2d');
  const hudScore=document.getElementById('score'), hudLevel=document.getElementById('level'), hudSpeed=document.getElementById('speed');
  const msg=document.getElementById('msg'), banner=document.getElementById('banner'), winEl=document.getElementById('win');
  const panelMask=document.getElementById('panelMask'), panel=document.getElementById('panel'), skinsWrap=document.getElementById('skins');
  const panelContent=document.getElementById('panelContent');
  const ctlRange=document.getElementById('ctlRange'), ctlVal=document.getElementById('ctlVal');
  const spdRange=document.getElementById('spdRange');
  const wallSel=document.getElementById('wallMode');
  const foodSel=document.getElementById('foodStyle');
  const speedUpSel=document.getElementById('speedUp');
  const levelModeSel=document.getElementById('levelMode');
  const tsRange=document.getElementById('tsRange'), tsVal=document.getElementById('tsVal');
  const boardPresetSel=document.getElementById('boardPreset');
  const startMask=document.getElementById('startMask'), startBtn=document.getElementById('startBtn');
  const sfxBtn=document.getElementById('sfx'), bgmBtn=document.getElementById('bgmToggle');
  const bgmEl=document.getElementById('bgm');
  const finaleMask=document.getElementById('finaleMask'), finaleTitle=document.getElementById('finaleTitle');
  document.getElementById('finaleRestart').onclick=()=>{ finaleMask.style.display='none'; initState(); };

  /* ---------- 设置载入 ---------- */
  const PRESETS={'30x22':[30,22],'26x18':[26,18],'22x16':[22,16]};
  let presetKey='26x18'; let W=26,H=18; let TILEPX=22;
  const saved=JSON.parse(localStorage.getItem('xy_snake_settings')||'{}');
  function setVar(n,v){ document.documentElement.style.setProperty(n,v); }

  if(saved.controlsH!=null){ setVar('--controlsH',saved.controlsH); ctlRange.value=saved.controlsH; ctlVal.textContent=saved.controlsH; }
  setVar('--controlsLift', 44); setVar('--actionsPadRight', 30);

  let startSpeed = saved.startSpeed!=null ? +saved.startSpeed : 7;
  let sfxOn = saved.sfxOn!==false;
  let bgmOn = saved.bgmOn!==false;
  let wallMode = saved.wallMode||'wrap';
  let foodStyle= saved.foodStyle||'pixel';
  let speedUp  = saved.speedUp||'off';
  let levelMode= saved.levelMode||'on';
  let targetScore = saved.targetScore||100;
  if(saved.boardPreset && PRESETS[saved.boardPreset]){ presetKey=saved.boardPreset; [W,H]=PRESETS[presetKey]; }
  boardPresetSel.value=presetKey;

  const confettiCount = 90;
  const confettiDur   = 1400;
  const MAX_LEVEL     = 7; // ← 你定的上限

  /* ---------- 皮肤 ---------- */
  const ALL_SKINS=[
    {key:'classic', name:'经典粉', head:'#ff6fa5', body:'#ff9fbc'},
    {key:'spring',  name:'春日绿', head:'#5ec48d', body:'#9be4c0'},
    {key:'ocean',   name:'海盐蓝', head:'#5ba7ff', body:'#9ed1ff'},
    {key:'sunset',  name:'落日晚', head:'#ff7a59', body:'#ffb59f'},
    {key:'grape',   name:'葡萄紫', head:'#9a6bff', body:'#c5a8ff'},
    {key:'crown',   name:'粉金王冠（纪念）', head:'#f3a6d6', body:'#ffd6ef'} // 终章解锁
  ];
  let unlocked = saved.unlocked||['classic'];
  let skinKey  = saved.skinKey||'classic';
  const COL={grid:'#ffffff35', head:'#ff6fa5', body:'#ff9fbc', eye:'#4c2d3a'};
  function applyPalette(){ const s=ALL_SKINS.find(k=>k.key===skinKey)||ALL_SKINS[0]; COL.head=s.head; COL.body=s.body; }
  function renderSkins(){
    skinsWrap.innerHTML='';
    ALL_SKINS.forEach(s=>{
      const have = unlocked.includes(s.key);
      const el=document.createElement('button');
      el.className='skin'+(have?'':' locked');
      el.textContent=(have?'':'🔒 ')+s.name;
      el.onclick=()=>{ if(!have) return; skinKey=s.key; applyPalette(); saveSettings(); renderSkins(); };
      skinsWrap.appendChild(el);
    });
  }
  renderSkins(); applyPalette();

  /* ---------- BGM：mp3 优先 / 8-bit 备胎 ---------- */
  let synthCtx=null, synthOn=false, bgmTried=false;
  bgmEl.volume=0.7;
  async function tryPlayBGM(){
    if(!bgmOn) return;
    try{ await bgmEl.play(); return; }
    catch(e){
      if(!synthCtx){
        synthCtx = new (window.AudioContext||window.webkitAudioContext)();
        const bpm=124, step=60/bpm/2;
        const scale=[0,2,4,7,9,12,14,16];
        function note(time, midi, dur=step){
          const o=synthCtx.createOscillator(), g=synthCtx.createGain();
          o.type='square'; o.frequency.value=440*Math.pow(2,(midi-69)/12);
          g.gain.setValueAtTime(0.11, time);
          g.gain.exponentialRampToValueAtTime(0.001, time+dur*0.95);
          o.connect(g).connect(synthCtx.destination);
          o.start(time); o.stop(time+dur);
        }
        let t = synthCtx.currentTime + 0.05;
        function loop(){
          if(!synthOn) return;
          for(let i=0;i<16;i++){
            const deg = scale[(i*2)%scale.length];
            const midi = 72 + deg + (i%8===0?12:0);
            note(t+i*step, midi, step*0.95);
          }
          t += 16*step;
          setTimeout(loop, 1000*16*step*0.9);
        }
        synthOn=true; loop();
      }
      if(synthCtx && synthCtx.state==='suspended'){ try{ await synthCtx.resume(); }catch{} }
    }
  }
  function stopSynth(){ synthOn=false; if(synthCtx){ try{synthCtx.close();}catch{} synthCtx=null; } }

  // 顶部按钮状态
  function uiToast(t){ msg.textContent=t; msg.style.display='block'; setTimeout(()=>{ msg.style.display='none'; },1200); }
  sfxBtn.textContent='音效: '+(sfxOn?'开':'关');
  bgmBtn.textContent='音乐: '+(bgmOn?'开':'关');
  bgmBtn.onclick=()=>{ bgmOn=!bgmOn; bgmBtn.textContent='音乐: '+(bgmOn?'开':'关'); saveSettings(); if(bgmOn) tryPlayBGM(); else { bgmEl.pause(); stopSynth(); } };
  sfxBtn.onclick=()=>{ sfxOn=!sfxOn; sfxBtn.textContent='音效: '+(sfxOn?'开':'关'); saveSettings(); };

  // 面板开关
  function togglePanel(show){
    if(show){ panelMask.classList.add('show'); document.body.style.touchAction='auto'; document.body.style.overflow='hidden'; panelContent.scrollTop=0; }
    else{ panelMask.classList.remove('show'); document.body.style.touchAction='none'; document.body.style.overflow=''; }
  }
  document.getElementById('menu').onclick=()=>togglePanel(true);
  panelMask.addEventListener('click', e=>{ if(e.target===panelMask) togglePanel(false); });
  document.getElementById('close').onclick=()=>togglePanel(false);
  document.getElementById('apply').onclick=()=>{ applySettings(true); togglePanel(false); };
  document.getElementById('reset').onclick=()=>{
    localStorage.removeItem('xy_snake_settings');
    ctlRange.value=45; ctlVal.textContent='45';
    sfxOn=true; bgmOn=true; sfxBtn.textContent='音效: 开'; bgmBtn.textContent='音乐: 开';
    wallMode='wrap'; foodStyle='pixel'; speedUp='off'; levelMode='on'; startSpeed=7; targetScore=100;
    boardPresetSel.value='26x18'; presetKey='26x18'; [W,H]=PRESETS[presetKey];
    unlocked=['classic']; skinKey='classic'; renderSkins(); applySettings(true); tryPlayBGM();
  };
  ctlRange.oninput=()=>{ ctlVal.textContent=ctlRange.value; setVar('--controlsH', ctlRange.value); };
  tsRange.oninput =()=>{ tsVal.textContent=tsRange.value; };

  function saveSettings(){
    localStorage.setItem('xy_snake_settings', JSON.stringify({
      controlsH:ctlRange.value,
      startSpeed, sfxOn, bgmOn, wallMode, foodStyle, speedUp,
      levelMode, targetScore, boardPreset:presetKey,
      unlocked, skinKey
    }));
  }
  function applySettings(persist){
    startSpeed=parseFloat(spdRange.value);
    wallMode=wallSel.value; foodStyle=foodSel.value; speedUp=speedUpSel.value; levelMode=levelModeSel.value; targetScore=parseInt(tsRange.value,10);
    const bp=boardPresetSel.value; let needReset=false;
    if(bp!==presetKey){ presetKey=bp; [W,H]=PRESETS[presetKey]; needReset=true; }
    if(persist) saveSettings();
    fit(); if(needReset) initState();
  }

  /* ---------- 交互 ---------- */
  let sx=0,sy=0,moved=false; const stage=document.getElementById('stage');
  stage.addEventListener('touchstart',e=>{ const t=e.touches[0]; sx=t.clientX; sy=t.clientY; moved=false; },{passive:true});
  stage.addEventListener('touchmove',()=>{ moved=true; },{passive:true});
  stage.addEventListener('touchend',e=>{ if(!moved) return; const t=e.changedTouches[0]; const dx=t.clientX-sx, dy=t.clientY-sy;
    if(Math.abs(dx)>Math.abs(dy)) setDir(dx>0?1:-1,0); else setDir(0,dy>0?1:-1); },{passive:true});
  document.getElementById('pause').onclick=()=>{ paused=!paused; vibr(8); };
  document.getElementById('restart').onclick=()=>{ initState(); vibr(15); };
  document.getElementById('up').onclick=()=>{ setDir(0,-1); vibr(10); };
  document.getElementById('down').onclick=()=>{ setDir(0, 1); vibr(10); };
  document.getElementById('left').onclick=()=>{ setDir(-1,0); vibr(10); };
  document.getElementById('right').onclick=()=>{ setDir(1, 0); vibr(10); };

  /* ---------- 自适配 ---------- */
  function setupCanvas(){
    const dpr=window.devicePixelRatio||1;
    const cssW=cv.clientWidth, cssH=cv.clientHeight;
    cv.width=Math.floor(cssW*dpr); cv.height=Math.floor(cssH*dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    conf.width=cv.width; conf.height=cv.height;
    cctx.setTransform(dpr,0,0,dpr,0,0);
  }
  function fit(){
    const r=document.getElementById('stage').getBoundingClientRect();
    const gw=Math.max(0,Math.floor(r.width)), gh=Math.max(0,Math.floor(r.height));
    const candX=Math.max(10,Math.floor(gw/W)), candY=Math.max(10,Math.floor(gh/H));
    TILEPX=Math.max(12,Math.min(candX,candY));
    const wpx=W*TILEPX, hpx=H*TILEPX;
    cv.style.width=wpx+'px'; cv.style.height=hpx+'px';
    conf.style.width=wpx+'px'; conf.style.height=hpx+'px';
    setupCanvas();
  }
  new ResizeObserver(fit).observe(document.getElementById('stage')); fit();

  /* ---------- 游戏状态 ---------- */
  let snake=[], dir=[1,0], queue=[];
  let len=4, speed=startSpeed, score=0, level=1, paused=true, over=false, win=false, overReason='';
  let apple=null, lastAppleAt=0; let mail=null, mailTTL=0;
  let cleared = saved.cleared||false;

  function vibr(ms){ try{ if('vibrate' in navigator) navigator.vibrate(ms);}catch(e){} }

  function initState(){
    const cx=Math.floor(W/2), cy=Math.floor(H/2);
    snake=[[cx,cy]]; dir=[1,0]; queue=[]; len=4;
    speed=startSpeed; score=0; level=1; paused=true; over=false; win=false; overReason='';
    apple=null; lastAppleAt=0; mail=null; mailTTL=0;
    hudScore.textContent='分数: '+score; hudLevel.textContent='关卡: '+level; hudSpeed.textContent='速度: '+speed.toFixed(1);
    msg.style.display='none'; winEl.style.display='none'; finaleMask.style.display='none';
    ensureApple(); draw();
  }

  function setDir(nx,ny){ if(nx===-dir[0]&&ny===-dir[1]) return; queue.push([nx,ny]); }

  function spawnAppleAvoidingSnake(occ){
    for(let t=0;t<2000;t++){
      const c=[Math.floor(Math.random()*W),Math.floor(Math.random()*H)];
      if(!occ.has(JSON.stringify(c))) return c;
    }
    for(let y=0;y<H;y++){ for(let x=0;x<W;x++){ const key=JSON.stringify([x,y]); if(!occ.has(key)) return [x,y]; } }
    return null;
  }
  function placeAppleNew(avoidSame=true){
    const occ=new Set(snake.map(JSON.stringify));
    if(avoidSame&&apple) occ.add(JSON.stringify(apple));
    const pos=spawnAppleAvoidingSnake(occ);
    if(pos){ apple=pos; lastAppleAt=performance.now(); }
  }
  function ensureApple(){ if(!apple) placeAppleNew(false); }

  function showBanner(text){ banner.textContent=text||'➡️ 下一关！'; banner.style.display='block'; setTimeout(()=>{banner.style.display='none';},900); }

  function unlockNextSkin(autoEquip = true){
    const allKeys = ALL_SKINS.map(s=>s.key);
    const locked  = allKeys.filter(k=>!unlocked.includes(k));
    if(locked.length === 0) return false;
    const nextKey = locked[0];
    unlocked.push(nextKey);
    if(autoEquip){ skinKey = nextKey; applyPalette(); }
    renderSkins(); saveSettings();
    showBanner('🌟 解锁皮肤：' + (ALL_SKINS.find(s=>s.key===nextKey).name) + '（已自动装备）');
    popConfetti();
    return true;
  }

  function maybeLevelUp(){
    if(levelMode!=='on') return;
    const need=targetScore*level;
    if(score>=need){
      level++;
      if(level<=MAX_LEVEL){
        hudLevel.textContent='关卡: '+level; showBanner('➡️ 第 '+level+' 关！');
        if(speedUp==='off'){ speed=Math.min(14, startSpeed+(level-1)*0.5); hudSpeed.textContent='速度: '+speed.toFixed(1); }
        if(level % 2 === 0) unlockNextSkin(true);
      }else{
        triggerFinale();
      }
    }
  }

  // 终章
  function triggerFinale(){
    // 解锁纪念皮肤并自动装备
    if(!unlocked.includes('crown')) unlocked.push('crown');
    skinKey='crown'; applyPalette(); renderSkins();
    cleared = true; saveSettings();
    finaleTitle.textContent = '🎀 恭喜你下班了！✨';
    finaleMask.style.display='flex';
    popConfetti();
  }

  // 彩纸
  let confettiStart=0, confettiP=[];
  function popConfetti(){
    confettiStart=performance.now(); confettiP=[];
    const N=confettiCount;
    const w=cv.clientWidth, h=cv.clientHeight;
    for(let i=0;i<N;i++){
      confettiP.push({x:Math.random()*w, y:h/2, vx:(Math.random()-0.5)*2, vy:(Math.random()-1.5)*3, a:Math.random()*Math.PI, s:2+Math.random()*3});
    }
    conf.style.display='block';
    requestAnimationFrame(stepConfetti);
  }
  function stepConfetti(now){
    cctx.clearRect(0,0,cv.clientWidth,cv.clientHeight);
    cctx.globalAlpha=0.9;
    for(const p of confettiP){
      p.x+=p.vx; p.y+=p.vy; p.vy+=0.05; p.a+=0.2;
      cctx.save(); cctx.translate(p.x,p.y); cctx.rotate(p.a); cctx.fillStyle='#ff7fb3'; cctx.fillRect(-p.s,-p.s,p.s*2,p.s*2); cctx.restore();
    }
    if(now-confettiStart<confettiDur) requestAnimationFrame(stepConfetti); else conf.style.display='none';
  }

  // 💌 + 食物绘制
  function drawCandy(x,y){ const t=TILEPX, px=x*t, py=y*t; const cx=px+t/2, cy=py+t/2, r=t*0.36;
    ctx.fillStyle='#ffd1e6';
    ctx.beginPath(); ctx.moveTo(px+2,cy); ctx.lineTo(px+6,cy-6); ctx.lineTo(px+6,cy+6); ctx.closePath(); ctx.fill();
    ctx.beginPath(); ctx.moveTo(px+t-2,cy); ctx.lineTo(px+t-6,cy-6); ctx.lineTo(px+t-6,cy+6); ctx.closePath(); ctx.fill();
    const grd=ctx.createRadialGradient(cx-2,cy-2,2,cx,cy,r+2); grd.addColorStop(0,'#ff7fb3'); grd.addColorStop(1,'#ff5fa3'); ctx.fillStyle=grd;
    ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.fill();
  }
  function drawPixelFood(x,y){ const t=TILEPX, px=x*t, py=y*t; const s=Math.max(8, t-10); const off=(t-s)/2;
    ctx.fillStyle='#ff2d6a'; ctx.fillRect(px+off,py+off,s,s); ctx.strokeStyle='#ffffffc0'; ctx.lineWidth=1; ctx.strokeRect(px+off+0.5,py+off+0.5,s-1,s-1); }

  /* ---------- 逻辑主循环 ---------- */
  function stepHead([hx,hy],[dx,dy]){
    let nx=hx+dx, ny=hy+dy;
    if(wallMode==='wrap'){ if(nx<0) nx=W-1; else if(nx>=W) nx=0; if(ny<0) ny=H-1; else if(ny>=H) ny=0; return [nx,ny,true]; }
    else{ if(nx<0||ny<0||nx>=W||ny>=H) return null; return [nx,ny,false]; }
  }

  function tick(){
    if(!paused && !over && !win && finaleMask.style.display!=='flex'){
      while(queue.length){ const [nx,ny]=queue.shift(); if(!(nx===-dir[0] && ny===-dir[1])){ dir=[nx,ny]; break; } }
      const [hx,hy]=snake[0]; const step=stepHead([hx,hy],dir);
      if(!step){ over=true; overReason='wall'; }
      else{
        const [nx,ny]=step; const head=[nx,ny];
        for(let i=0;i<snake.length;i++){ if(snake[i][0]===nx&&snake[i][1]===ny){ over=true; overReason='tail'; break; } }
        if(!over){
          snake.unshift(head); if(snake.length>len) snake.pop();
          ensureApple(); if(apple && performance.now()-lastAppleAt>5000){ placeAppleNew(true); }
          if(apple && head[0]===apple[0] && head[1]===apple[1]){
            len++; score+=10; if(speedUp==='on'){ speed=Math.min(14, speed+0.25); }
            placeAppleNew(true); hudScore.textContent='分数: '+score; hudSpeed.textContent='速度: '+speed.toFixed(1);
            if(!mail && Math.random()<0.06){ const occ=new Set(snake.map(JSON.stringify)); mail = spawnAppleAvoidingSnake(occ); mailTTL=500; }
            maybeLevelUp();
          }
          if(mail){
            if(head[0]===mail[0] && head[1]===mail[1]){ score += 20; hudScore.textContent = '分数: ' + score + ' (+20)'; mail = null; advanceLevel(); }
            else if(--mailTTL<=0){ mail=null; }
          }
        }
      }
    }
    draw(); setTimeout(tick, 1000/Math.max(5, speed));
  }

  function advanceLevel(){
    level++; hudLevel.textContent = '关卡: ' + Math.min(level, MAX_LEVEL); showBanner('➡️ 第 ' + Math.min(level, MAX_LEVEL) + ' 关！');
    if (level <= MAX_LEVEL && speedUp === 'off') { speed = Math.min(14, startSpeed + (level - 1) * 0.5); hudSpeed.textContent = '速度: ' + speed.toFixed(1); }
    if (level % 2 === 0 && level <= MAX_LEVEL) unlockNextSkin(true);
    const cx = Math.floor(W/2), cy = Math.floor(H/2);
    snake = [[cx, cy]]; len = 4; dir = [1,0]; queue = [];
    over = false; win = false; apple = null; ensureApple(); mail = null; mailTTL = 0; popConfetti();
    if(level > MAX_LEVEL) triggerFinale();
  }

  /* ---------- 绘制 ---------- */
  function rr(x,y,w,h,r){ r=Math.min(r,w/2,h/2); const p=ctx; p.beginPath(); p.moveTo(x+r,y); p.arcTo(x+w,y,x+w,y+h,r); p.arcTo(x+w,y+h,x,y+h,r); p.arcTo(x,y+h,x,y,r); p.arcTo(x,y,x+w,y,r); p.closePath(); }
  function headCell(x,y){ const t=TILEPX, px=x*t, py=y*t; ctx.fillStyle=COL.head; rr(px+1,py+1,t-2,t-2,Math.min(10,t/2)); ctx.fill(); ctx.fillStyle=COL.eye; ctx.beginPath(); ctx.arc(px+t*0.35, py+t*0.40, Math.max(2,t*0.1), 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(px+t*0.65, py+t*0.40, Math.max(2,t*0.1), 0, Math.PI*2); ctx.fill(); }
  function bodyCell(x,y){ const t=TILEPX, px=x*t, py=y*t; ctx.fillStyle=COL.body; rr(px+1,py+1,t-2,t-2,Math.min(10,t/2)); ctx.fill(); }
  function draw(){
    const t=TILEPX; ctx.clearRect(0,0,cv.width,cv.height);
    ctx.strokeStyle=COL.grid; ctx.lineWidth=0.6;
    for(let x=0;x<=W;x++){ ctx.beginPath(); ctx.moveTo(x*t+0.5,0); ctx.lineTo(x*t+0.5,H*t); ctx.stroke(); }
    for(let y=0;y<=H;y++){ ctx.beginPath(); ctx.moveTo(0,y*t+0.5); ctx.lineTo(W*t,y*t+0.5); ctx.stroke(); }
    if(!apple) ensureApple();
    if(apple){ (foodStyle==='pixel'?drawPixelFood:drawCandy)(apple[0],apple[1]); }
    if(mail) drawCandy(mail[0],mail[1]);
    for(let i=0;i<snake.length;i++){ const [x,y]=snake[i]; if(i===0) headCell(x,y); else bodyCell(x,y); }
    if(over){ msg.textContent = (overReason==='tail' ? 'Game Over ～ 咬到尾巴了' : 'Game Over ～ 撞墙啦'); msg.style.display='block'; } else if(!win){ msg.style.display='none'; }
  }

  /* ---------- 启动：任意点一下就能开始 ---------- */
  let started=false;
  function startGame(){ if(started) return; started=true; startMask.style.display='none'; paused=false; }
  async function tryStart(e){ if(e){ try{e.preventDefault(); e.stopPropagation();}catch{} } try{ await tryPlayBGM(); }catch{} startGame(); }
  ['click','touchstart','pointerdown'].forEach(ev=>{ startBtn.addEventListener(ev, tryStart, {passive:false}); });
  ['click','touchstart','pointerdown'].forEach(ev=>{ startMask.addEventListener(ev, (e)=>{ if(e.target===startMask) tryStart(e); }, {passive:false}); });
  ['click','touchstart','pointerdown'].forEach(ev=>{
    document.addEventListener(ev, (e)=>{ if(!started) tryStart(e); }, {passive:false, once:true, capture:true});
  });

  /* ---------- 初始化 ---------- */
  function preventPanelScrollLeak(){ panelContent.addEventListener('touchmove',()=>{}, {passive:true}); }
  preventPanelScrollLeak();
  initState(); fit(); tick();
})();
</script>
</body>
</html>

  /* “开始”遮罩：fixed + 顶层 + 任意点可开始 */
  #startMask{
    position: fixed; inset:0; display:flex; align-items:center; justify-content:center;
    background:rgba(255,230,240,.85); z-index: 9999; pointer-events:auto;
  }
  #startMask *{ pointer-events:auto; }
  #startCard{background:#fff7fb; border:1px solid #ffd1e2; border-radius:14px; padding:18px 20px; box-shadow:0 14px 38px rgba(0,0,0,.12); text-align:center;}
  #startCard h1{margin:0 0 10px; font-size:18px; color:#a23e6b;}
  #startBtn{padding:10px 18px; border:none; border-radius:12px; background:#ffb7d1; color:#fff; font-weight:600; box-shadow:0 6px 16px rgba(255,105,180,.28);}
</style>
</head>
<body>
<div id="wrap">
  <div id="gameArea">
    <div id="stage">
      <canvas id="cv" width="660" height="484" aria-label="游戏画面"></canvas>
      <canvas id="confetti"></canvas>
      <div id="hud"><span id="score">分数: 0</span><span id="level">关卡: 1</span><span id="speed">速度: 7</span></div>
      <div id="msg" role="alert"></div>
      <div id="banner">➡️ 下一关！</div>
      <div id="win">💖 恭喜通关！</div>

      <!-- 开始遮罩 -->
      <div id="startMask">
        <div id="startCard">
          <h1>粉粉贪吃蛇 · 小悠特别版</h1>
          <button id="startBtn">▶ 开始游戏</button>
        </div>
      </div>

      <div id="settings">
        <button class="chip" id="menu">⚙️ 设置</button>
        <button class="chip" id="sfx">音效: 开</button>
        <button class="chip" id="bgmToggle">音乐: 开</button>
      </div>

      <!-- 设置面板（精简 + 皮肤手选） -->
      <div id="panelMask">
        <div id="panel">
          <label>按键区高度（% 屏幕，0–100）：<span id="ctlVal">45</span>%</label>
          <input id="ctlRange" type="range" min="0" max="100" step="1" value="45"/>

          <div class="row">
            <label style="min-width:110px;">棋盘颗粒：</label>
            <select id="boardPreset">
              <option value="30x22">标准 (30×22)</option>
              <option value="26x18" selected>大号 (26×18)</option>
              <option value="22x16">超大 (22×16)</option>
            </select>
          </div>

          <div class="row">
            <label style="min-width:110px;">撞墙规则：</label>
            <select id="wallMode">
              <option value="wrap" selected>穿越（不死亡）</option>
              <option value="die">死亡</option>
            </select>
          </div>

          <div class="row">
            <label style="min-width:110px;">食物样式：</label>
            <select id="foodStyle">
              <option value="pixel" selected>像素点</option>
              <option value="candy">糖果</option>
            </select>
          </div>

          <div class="row">
            <label style="min-width:110px;">吃到是否加速：</label>
            <select id="speedUp">
              <option value="off" selected>关（保持初始）</option>
              <option value="on">开（每个+0.25）</option>
            </select>
          </div>

          <label>蛇速起始值：</label>
          <input id="spdRange" type="range" min="5" max="10" step="0.5" value="7"/>

          <hr style="border:none;border-top:1px solid #ffd4e4;margin:8px 8px;">

          <div class="row">
            <label style="min-width:110px;">关卡模式：</label>
            <select id="levelMode">
              <option value="on" selected>开（每 +100 分升一关）</option>
              <option value="off">关（无尽）</option>
            </select>
          </div>
          <label>每关目标分（20–200）：<span id="tsVal">100</span></label>
          <input id="tsRange" type="range" min="20" max="200" step="10" value="100"/>

          <hr style="border:none;border-top:1px solid #ffd4e4;margin:8px 8px;">

          <label>当前皮肤（可点击切换，🔒为未解锁）：</label>
          <div id="skins"></div>

          <div class="spacer" style="height:80px;" aria-hidden="true"></div>

          <div class="sticky" style="display:flex; gap:6px; flex-wrap:wrap;">
            <button class="chip" id="apply">应用并保存</button>
            <button class="chip" id="close">关闭</button>
            <button class="chip" id="reset">重置默认</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="controls" aria-label="控制区">
    <div id="controlsInner">
      <div id="dpadWrap">
        <div id="dpad">
          <button class="btn" id="up"    style="grid-area:up;">↑</button>
          <button class="btn" id="left"  style="grid-area:left;">←</button>
          <button class="btn" id="right" style="grid-area:right;">→</button>
          <button class="btn" id="down"  style="grid-area:down;">↓</button>
        </div>
      </div>
      <div id="actionsWrap">
        <button id="pause" title="暂停">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><rect x="6" y="5" width="4" height="14" fill="white"/><rect x="14" y="5" width="4" height="14" fill="white"/></svg>
        </button>
        <button id="restart" title="重新开始">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 5v-3l5 4-5 4V7a5 5 0 1 0 5 5h2A7 7 0 1 1 12 5z" fill="white"/></svg>
        </button>
      </div>
    </div>
  </div>
</div>

<audio id="bgm" src="friendship.mp3" preload="auto" loop playsinline></audio>

<script>
  // SW 注册 + iOS 视口修正
  if ('serviceWorker' in navigator) { navigator.serviceWorker.register('service-worker.js').catch(()=>{}); }
  (function(){ function setVH(){const vv=window.visualViewport;const h=(vv?vv.height:window.innerHeight);document.documentElement.style.setProperty('--vh',(h/100)+'px');}
    setVH(); addEventListener('resize',setVH); if(window.visualViewport){visualViewport.addEventListener('resize',setVH);} })();
</script>

<script>
(function(){ 'use strict';
  /* ---------- DOM ---------- */
  const cv=document.getElementById('cv'), ctx=cv.getContext('2d');
  const conf=document.getElementById('confetti'), cctx=conf.getContext('2d');
  const hudScore=document.getElementById('score'), hudLevel=document.getElementById('level'), hudSpeed=document.getElementById('speed');
  const msg=document.getElementById('msg'), banner=document.getElementById('banner'), winEl=document.getElementById('win');
  const panelMask=document.getElementById('panelMask'), panel=document.getElementById('panel'), skinsWrap=document.getElementById('skins');
  const ctlRange=document.getElementById('ctlRange'), ctlVal=document.getElementById('ctlVal');
  const spdRange=document.getElementById('spdRange');
  const wallSel=document.getElementById('wallMode');
  const foodSel=document.getElementById('foodStyle');
  const speedUpSel=document.getElementById('speedUp');
  const levelModeSel=document.getElementById('levelMode');
  const tsRange=document.getElementById('tsRange'), tsVal=document.getElementById('tsVal');
  const boardPresetSel=document.getElementById('boardPreset');
  const startMask=document.getElementById('startMask'), startBtn=document.getElementById('startBtn');
  const sfxBtn=document.getElementById('sfx'), bgmBtn=document.getElementById('bgmToggle');
  const bgmEl=document.getElementById('bgm');

  /* ---------- 设置载入（精简） ---------- */
  const PRESETS={'30x22':[30,22],'26x18':[26,18],'22x16':[22,16]};
  let presetKey='26x18'; let W=26,H=18; let TILEPX=22;
  const saved=JSON.parse(localStorage.getItem('xy_snake_settings')||'{}');
  function setVar(n,v){ document.documentElement.style.setProperty(n,v); }

  if(saved.controlsH!=null){ setVar('--controlsH',saved.controlsH); ctlRange.value=saved.controlsH; ctlVal.textContent=saved.controlsH; }
  setVar('--controlsLift', 44); setVar('--actionsPadRight', 30);

  let startSpeed = saved.startSpeed!=null ? +saved.startSpeed : 7;
  let sfxOn = saved.sfxOn!==false;
  let bgmOn = saved.bgmOn!==false;
  let wallMode = saved.wallMode||'wrap';
  let foodStyle= saved.foodStyle||'pixel';
  let speedUp  = saved.speedUp||'off';
  let levelMode= saved.levelMode||'on';
  let targetScore = saved.targetScore||100;
  if(saved.boardPreset && PRESETS[saved.boardPreset]){ presetKey=saved.boardPreset; [W,H]=PRESETS[presetKey]; }
  boardPresetSel.value=presetKey;

  const confettiCount = 80;
  const confettiDur   = 1200;
  const rewardPoints  = 50;

  /* ---------- 皮肤 ---------- */
  const ALL_SKINS=[
    {key:'classic', name:'经典粉', head:'#ff6fa5', body:'#ff9fbc'},
    {key:'spring',  name:'春日绿', head:'#5ec48d', body:'#9be4c0'},
    {key:'ocean',   name:'海盐蓝', head:'#5ba7ff', body:'#9ed1ff'},
    {key:'sunset',  name:'落日晚', head:'#ff7a59', body:'#ffb59f'},
    {key:'grape',   name:'葡萄紫', head:'#9a6bff', body:'#c5a8ff'}
  ];
  let unlocked = saved.unlocked||['classic'];
  let skinKey  = saved.skinKey||'classic';
  const COL={grid:'#ffffff35', head:'#ff6fa5', body:'#ff9fbc', eye:'#4c2d3a'};
  function applyPalette(){ const s=ALL_SKINS.find(k=>k.key===skinKey)||ALL_SKINS[0]; COL.head=s.head; COL.body=s.body; }
  function renderSkins(){
    skinsWrap.innerHTML='';
    ALL_SKINS.forEach(s=>{
      const el=document.createElement('button');
      el.className='skin'+(unlocked.includes(s.key)?'':' locked');
      el.textContent=(unlocked.includes(s.key)?'':'🔒 ')+s.name;
      el.onclick=()=>{ if(!unlocked.includes(s.key)) return; skinKey=s.key; applyPalette(); saveSettings(); renderSkins(); };
      skinsWrap.appendChild(el);
    });
  }
  renderSkins(); applyPalette();

  /* ---------- 背景音乐：mp3 优先 / 8-bit 备胎 ---------- */
  let bgmTried=false, synthCtx=null, synthOn=false;
  bgmEl.volume=0.7;
  async function tryPlayBGM(){
    if(!bgmOn) return;
    try{ await bgmEl.play(); return; }
    catch(e){
      if(!synthCtx){
        synthCtx = new (window.AudioContext||window.webkitAudioContext)();
        const bpm=128, step=60/bpm/2;
        const scale=[0,2,4,7,9,12,14,16];
        function note(time, midi, dur=step){
          const o=synthCtx.createOscillator(), g=synthCtx.createGain();
          o.type='square'; o.frequency.value=440*Math.pow(2,(midi-69)/12);
          g.gain.setValueAtTime(0.12, time);
          g.gain.exponentialRampToValueAtTime(0.001, time+dur*0.95);
          o.connect(g).connect(synthCtx.destination);
          o.start(time); o.stop(time+dur);
        }
        let t = synthCtx.currentTime + 0.05;
        function loop(){
          if(!synthOn) return;
          for(let i=0;i<16;i++){
            const deg = scale[(i*2)%scale.length];
            const midi = 72 + deg + (i%8===0?12:0);
            note(t+i*step, midi, step*0.95);
          }
          t += 16*step;
          setTimeout(loop, 1000*16*step*0.9);
        }
        synthOn=true; loop();
      }
      if(synthCtx && synthCtx.state==='suspended'){ try{ await synthCtx.resume(); }catch{} }
    }
  }
  function stopSynth(){ synthOn=false; if(synthCtx){ try{synthCtx.close();}catch{} synthCtx=null; } }

  // 顶部按钮状态
  function uiToast(t){ msg.textContent=t; msg.style.display='block'; setTimeout(()=>{ msg.style.display='none'; },1200); }
  document.getElementById('bgmToggle').textContent='音乐: '+(bgmOn?'开':'关');
  document.getElementById('sfx').textContent='音效: '+(sfxOn?'开':'关');
  document.getElementById('bgmToggle').onclick=()=>{ bgmOn=!bgmOn; document.getElementById('bgmToggle').textContent='音乐: '+(bgmOn?'开':'关'); saveSettings(); if(bgmOn) tryPlayBGM(); else { bgmEl.pause(); stopSynth(); } };
  document.getElementById('sfx').onclick=()=>{ sfxOn=!sfxOn; document.getElementById('sfx').textContent='音效: '+(sfxOn?'开':'关'); saveSettings(); };

  // 面板开关
  function togglePanel(show){
    if(show){ panelMask.classList.add('show'); document.body.style.touchAction='auto'; document.body.style.overflow='hidden'; }
    else{ panelMask.classList.remove('show'); document.body.style.touchAction='none'; document.body.style.overflow=''; }
  }
  document.getElementById('menu').onclick=()=>togglePanel(true);
  panelMask.addEventListener('click', e=>{ if(e.target===panelMask) togglePanel(false); });
  document.getElementById('close').onclick=()=>togglePanel(false);
  document.getElementById('apply').onclick=()=>{ applySettings(true); togglePanel(false); };
  document.getElementById('reset').onclick=()=>{
    localStorage.removeItem('xy_snake_settings');
    ctlRange.value=45; ctlVal.textContent='45';
    sfxOn=true; bgmOn=true; document.getElementById('sfx').textContent='音效: 开'; document.getElementById('bgmToggle').textContent='音乐: 开';
    wallMode='wrap'; foodStyle='pixel'; speedUp='off'; levelMode='on'; startSpeed=7; targetScore=100;
    boardPresetSel.value='26x18'; presetKey='26x18'; [W,H]=PRESETS[presetKey];
    unlocked=['classic']; skinKey='classic'; renderSkins(); applySettings(true); tryPlayBGM();
  };

  // 即时 UI
  ctlRange.oninput=()=>{ ctlVal.textContent=ctlRange.value; setVar('--controlsH', ctlRange.value); };
  tsRange.oninput =()=>{ tsVal.textContent=tsRange.value; };

  function saveSettings(){
    localStorage.setItem('xy_snake_settings', JSON.stringify({
      controlsH:ctlRange.value,
      startSpeed, sfxOn, bgmOn, wallMode, foodStyle, speedUp,
      levelMode, targetScore, boardPreset:presetKey,
      unlocked, skinKey
    }));
  }
  function applySettings(persist){
    startSpeed=parseFloat(spdRange.value);
    wallMode=wallSel.value; foodStyle=foodSel.value; speedUp=speedUpSel.value; levelMode=levelModeSel.value; targetScore=parseInt(tsRange.value,10);
    const bp=boardPresetSel.value; let needReset=false;
    if(bp!==presetKey){ presetKey=bp; [W,H]=PRESETS[presetKey]; needReset=true; }
    if(persist) saveSettings();
    fit(); if(needReset) initState();
  }

  /* ---------- 交互 ---------- */
  let sx=0,sy=0,moved=false; const stage=document.getElementById('stage');
  stage.addEventListener('touchstart',e=>{ const t=e.touches[0]; sx=t.clientX; sy=t.clientY; moved=false; },{passive:true});
  stage.addEventListener('touchmove',()=>{ moved=true; },{passive:true});
  stage.addEventListener('touchend',e=>{ if(!moved) return; const t=e.changedTouches[0]; const dx=t.clientX-sx, dy=t.clientY-sy;
    if(Math.abs(dx)>Math.abs(dy)) setDir(dx>0?1:-1,0); else setDir(0,dy>0?1:-1); },{passive:true});

  document.getElementById('pause').onclick=()=>{ paused=!paused; vibr(8); };
  document.getElementById('restart').onclick=()=>{ initState(); vibr(15); };

  document.getElementById('up').onclick=()=>{ setDir(0,-1); vibr(10); };
  document.getElementById('down').onclick=()=>{ setDir(0, 1); vibr(10); };
  document.getElementById('left').onclick=()=>{ setDir(-1,0); vibr(10); };
  document.getElementById('right').onclick=()=>{ setDir(1, 0); vibr(10); };

  /* ---------- 画布自适配 ---------- */
  function setupCanvas(){
    const dpr=window.devicePixelRatio||1;
    const cssW=cv.clientWidth, cssH=cv.clientHeight;
    cv.width=Math.floor(cssW*dpr); cv.height=Math.floor(cssH*dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    conf.width=cv.width; conf.height=cv.height;
    cctx.setTransform(dpr,0,0,dpr,0,0);
  }
  function fit(){
    const r=document.getElementById('stage').getBoundingClientRect();
    const gw=Math.max(0,Math.floor(r.width)), gh=Math.max(0,Math.floor(r.height));
    const candX=Math.max(10,Math.floor(gw/W)), candY=Math.max(10,Math.floor(gh/H));
    TILEPX=Math.max(12,Math.min(candX,candY));
    const wpx=W*TILEPX, hpx=H*TILEPX;
    cv.style.width=wpx+'px'; cv.style.height=hpx+'px';
    conf.style.width=wpx+'px'; conf.style.height=hpx+'px';
    setupCanvas();
  }
  new ResizeObserver(fit).observe(document.getElementById('stage')); fit();

  /* ---------- 游戏状态与逻辑 ---------- */
  let snake=[], dir=[1,0], queue=[];
  let len=4, speed=startSpeed, score=0, level=1, paused=true, over=false, win=false, overReason='';
  let apple=null, lastAppleAt=0; let mail=null, mailTTL=0;  // 💌

  function vibr(ms){ try{ if('vibrate' in navigator) navigator.vibrate(ms);}catch(e){} }

  function initState(){
    const cx=Math.floor(W/2), cy=Math.floor(H/2);
    snake=[[cx,cy]]; dir=[1,0]; queue=[]; len=4;
    speed=startSpeed; score=0; level=1; paused=true; over=false; win=false; overReason='';
    apple=null; lastAppleAt=0; mail=null; mailTTL=0;
    hudScore.textContent='分数: '+score; hudLevel.textContent='关卡: '+level; hudSpeed.textContent='速度: '+speed.toFixed(1);
    msg.style.display='none'; winEl.style.display='none';
    ensureApple(); draw();
  }

  function setDir(nx,ny){ if(nx===-dir[0]&&ny===-dir[1]) return; queue.push([nx,ny]); }

  function spawnAppleAvoidingSnake(occ){
    for(let t=0;t<2000;t++){
      const c=[Math.floor(Math.random()*W),Math.floor(Math.random()*H)];
      if(!occ.has(JSON.stringify(c))) return c;
    }
    for(let y=0;y<H;y++){ for(let x=0;x<W;x++){ const key=JSON.stringify([x,y]); if(!occ.has(key)) return [x,y]; } }
    return null;
  }
  function placeAppleNew(avoidSame=true){
    const occ=new Set(snake.map(JSON.stringify));
    if(avoidSame&&apple) occ.add(JSON.stringify(apple));
    const pos=spawnAppleAvoidingSnake(occ);
    if(pos){ apple=pos; lastAppleAt=performance.now(); }
  }
  function ensureApple(){ if(!apple) placeAppleNew(false); }

  function showBanner(text){ banner.textContent=text||'➡️ 下一关！'; banner.style.display='block'; setTimeout(()=>{banner.style.display='none';},900); }

  function unlockNextSkin(autoEquip = true){
    const allKeys = ALL_SKINS.map(s=>s.key);
    const locked  = allKeys.filter(k=>!unlocked.includes(k));
    if(locked.length === 0){ showBanner('🌟 皮肤已全部解锁'); return false; }
    const nextKey = locked[0];
    unlocked.push(nextKey);
    const nextSkin = ALL_SKINS.find(s=>s.key===nextKey);
    if(autoEquip){ skinKey = nextKey; applyPalette(); }
    renderSkins(); saveSettings();
    showBanner('🌟 解锁皮肤：' + nextSkin.name + '（已自动装备）');
    popConfetti();
    return true;
  }

  function maybeLevelUp(){
    if(levelMode!=='on') return;
    const need=targetScore*level;
    if(score>=need){
      level++; hudLevel.textContent='关卡: '+level; showBanner('➡️ 第 '+level+' 关！');
      if(speedUp==='off'){ speed=Math.min(14, startSpeed+(level-1)*0.5); hudSpeed.textContent='速度: '+speed.toFixed(1); }
      if(level % 2 === 0) unlockNextSkin(true);
    }
  }

  // 彩纸
  let confettiStart=0, confettiP=[];
  function popConfetti(){
    confettiStart=performance.now(); confettiP=[];
    const N=confettiCount;
    const w=cv.clientWidth, h=cv.clientHeight;
    for(let i=0;i<N;i++){
      confettiP.push({x:Math.random()*w, y:h/2, vx:(Math.random()-0.5)*2, vy:(Math.random()-1.5)*3, a:Math.random()*Math.PI, s:2+Math.random()*3});
    }
    conf.style.display='block';
    requestAnimationFrame(stepConfetti);
  }
  function stepConfetti(now){
    cctx.clearRect(0,0,cv.clientWidth,cv.clientHeight);
    cctx.globalAlpha=0.9;
    for(const p of confettiP){
      p.x+=p.vx; p.y+=p.vy; p.vy+=0.05; p.a+=0.2;
      cctx.save(); cctx.translate(p.x,p.y); cctx.rotate(p.a); cctx.fillStyle='#ff7fb3'; cctx.fillRect(-p.s,-p.s,p.s*2,p.s*2); cctx.restore();
    }
    if(now-confettiStart<confettiDur) requestAnimationFrame(stepConfetti); else conf.style.display='none';
  }

  // 🍭 💌 画法 + 直接进入下一关
  function drawCandy(x,y){ const t=TILEPX, px=x*t, py=y*t; const cx=px+t/2, cy=py+t/2, r=t*0.36;
    ctx.fillStyle='#ffd1e6';
    ctx.beginPath(); ctx.moveTo(px+2,cy); ctx.lineTo(px+6,cy-6); ctx.lineTo(px+6,cy+6); ctx.closePath(); ctx.fill();
    ctx.beginPath(); ctx.moveTo(px+t-2,cy); ctx.lineTo(px+t-6,cy-6); ctx.lineTo(px+t-6,cy+6); ctx.closePath(); ctx.fill();
    const grd=ctx.createRadialGradient(cx-2,cy-2,2,cx,cy,r+2); grd.addColorStop(0,'#ff7fb3'); grd.addColorStop(1,'#ff5fa3'); ctx.fillStyle=grd;
    ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.fill();
  }

  function advanceLevel(){
    level++; hudLevel.textContent = '关卡: ' + level; showBanner('➡️ 第 ' + level + ' 关！');
    if (speedUp === 'off') { speed = Math.min(14, startSpeed + (level - 1) * 0.5); hudSpeed.textContent = '速度: ' + speed.toFixed(1); }
    if (level % 2 === 0) unlockNextSkin(true);
    const cx = Math.floor(W/2), cy = Math.floor(H/2);
    snake = [[cx, cy]]; len = 4; dir = [1,0]; queue = [];
    over = false; win = false; apple = null; ensureApple(); mail = null; mailTTL = 0; popConfetti();
  }

  function stepHead([hx,hy],[dx,dy]){
    let nx=hx+dx, ny=hy+dy;
    if(wallMode==='wrap'){ if(nx<0) nx=W-1; else if(nx>=W) nx=0; if(ny<0) ny=H-1; else if(ny>=H) ny=0; return [nx,ny,true]; }
    else{ if(nx<0||ny<0||nx>=W||ny>=H) return null; return [nx,ny,false]; }
  }

  function tick(){
    if(!paused && !over && !win){
      while(queue.length){ const [nx,ny]=queue.shift(); if(!(nx===-dir[0] && ny===-dir[1])){ dir=[nx,ny]; break; } }
      const [hx,hy]=snake[0]; const step=stepHead([hx,hy],dir);
      if(!step){ over=true; overReason='wall'; }
      else{
        const [nx,ny]=step; const head=[nx,ny];
        for(let i=0;i<snake.length;i++){ if(snake[i][0]===nx&&snake[i][1]===ny){ over=true; overReason='tail'; break; } }
        if(!over){
          snake.unshift(head); if(snake.length>len) snake.pop();
          ensureApple(); if(apple && performance.now()-lastAppleAt>5000){ placeAppleNew(true); }
          if(apple && head[0]===apple[0] && head[1]===apple[1]){
            len++; score+=10; if(speedUp==='on'){ speed=Math.min(14, speed+0.25); }
            placeAppleNew(true); hudScore.textContent='分数: '+score; hudSpeed.textContent='速度: '+speed.toFixed(1);
            if(!mail && Math.random()<0.06){ const occ=new Set(snake.map(JSON.stringify)); mail = spawnAppleAvoidingSnake(occ); mailTTL=500; }
            maybeLevelUp();
          }
          if(mail){
            if(head[0]===mail[0] && head[1]===mail[1]){ score += 20; hudScore.textContent = '分数: ' + score + ' (+20)'; mail = null; advanceLevel(); }
            else if(--mailTTL<=0){ mail=null; }
          }
        }
      }
    }
    draw(); setTimeout(tick, 1000/Math.max(5, speed));
  }

  /* ---------- 绘制 ---------- */
  function rr(x,y,w,h,r){ r=Math.min(r,w/2,h/2); const p=ctx; p.beginPath(); p.moveTo(x+r,y); p.arcTo(x+w,y,x+w,y+h,r); p.arcTo(x+w,y+h,x,y+h,r); p.arcTo(x,y+h,x,y,r); p.arcTo(x,y,x+w,y,r); p.closePath(); }
  function headCell(x,y){ const t=TILEPX, px=x*t, py=y*t; ctx.fillStyle=COL.head; rr(px+1,py+1,t-2,t-2,Math.min(10,t/2)); ctx.fill(); ctx.fillStyle=COL.eye; ctx.beginPath(); ctx.arc(px+t*0.35, py+t*0.40, Math.max(2,t*0.1), 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(px+t*0.65, py+t*0.40, Math.max(2,t*0.1), 0, Math.PI*2); ctx.fill(); }
  function bodyCell(x,y){ const t=TILEPX, px=x*t, py=y*t; ctx.fillStyle=COL.body; rr(px+1,py+1,t-2,t-2,Math.min(10,t/2)); ctx.fill(); }
  function drawPixelFood(x,y){ const t=TILEPX, px=x*t, py=y*t; const s=Math.max(8, t-10); const off=(t-s)/2; ctx.fillStyle='#ff3366'; ctx.fillRect(px+off,py+off,s,s); ctx.strokeStyle='#ffffff90'; ctx.strokeRect(px+off+0.5,py+off+0.5,s-1,s-1); }
  function draw(){
    const t=TILEPX; ctx.clearRect(0,0,cv.width,cv.height);
    ctx.strokeStyle=COL.grid; ctx.lineWidth=0.6;
    for(let x=0;x<=W;x++){ ctx.beginPath(); ctx.moveTo(x*t+0.5,0); ctx.lineTo(x*t+0.5,H*t); ctx.stroke(); }
    for(let y=0;y<=H;y++){ ctx.beginPath(); ctx.moveTo(0,y*t+0.5); ctx.lineTo(W*t,y*t+0.5); ctx.stroke(); }
    if(!apple) ensureApple();
    if(apple){ (foodStyle==='pixel'?drawPixelFood:drawCandy)(apple[0],apple[1]); }
    if(mail) drawCandy(mail[0],mail[1]);
    for(let i=0;i<snake.length;i++){ const [x,y]=snake[i]; if(i===0) headCell(x,y); else bodyCell(x,y); }
    if(over){ msg.textContent = (overReason==='tail' ? 'Game Over ～ 咬到尾巴了' : 'Game Over ～ 撞墙啦'); msg.style.display='block'; } else if(!win){ msg.style.display='none'; }
  }

  /* ---------- 启动 & BGM 解锁（任意点一下就能开始） ---------- */
  let started=false;
  function startGame(){ if(started) return; started=true; startMask.style.display='none'; paused=false; }
  async function tryStart(e){ if(e){ try{e.preventDefault(); e.stopPropagation();}catch{} } try{ await tryPlayBGM(); }catch{} startGame(); }
  ['click','touchstart','pointerdown'].forEach(ev=>{ startBtn.addEventListener(ev, tryStart, {passive:false}); });
  ['click','touchstart','pointerdown'].forEach(ev=>{ startMask.addEventListener(ev, (e)=>{ if(e.target===startMask) tryStart(e); }, {passive:false}); });
  ['click','touchstart','pointerdown'].forEach(ev=>{
    document.addEventListener(ev, (e)=>{ if(!started) tryStart(e); }, {passive:false, once:true, capture:true});
  });

  /* ---------- 初始化 ---------- */
  initState(); fit(); tick();
})();
</script>
</body>
</html>
